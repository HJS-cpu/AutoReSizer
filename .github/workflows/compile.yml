name: Compile AHK v2 Script
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  compile:
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup AutoHotkey Environment
        shell: powershell
        run: |
          # Temp-Verzeichnis
          $tempDir = "C:\ahk_temp"
          New-Item -ItemType Directory -Path $tempDir -Force
          
          # AutoHotkey v2 herunterladen
          $downloadUrl = "https://github.com/AutoHotkey/AutoHotkey/releases/download/v2.0.11/AutoHotkey_2.0.11.zip"
          $zipPath = "$tempDir\ahk.zip"
          
          Write-Host "Downloading AutoHotkey v2.0.11..."
          Invoke-WebRequest -Uri $downloadUrl -OutFile $zipPath
          
          Write-Host "Extracting..."
          Expand-Archive -Path $zipPath -DestinationPath "$tempDir\ahk" -Force
          
          # Pfade setzen
          $ahkDir = "$tempDir\ahk"
          $compiler = Get-ChildItem -Path $ahkDir -Recurse -Filter "Ahk2Exe.exe" | Select-Object -First 1
          $baseFile = Get-ChildItem -Path $ahkDir -Recurse -Filter "AutoHotkey64.exe" | Select-Object -First 1
          
          Write-Host "Compiler found at: $($compiler.FullName)"
          Write-Host "Base file found at: $($baseFile.FullName)"
          
          # Environment Variables setzen für nächste Steps
          echo "AHK2EXE_PATH=$($compiler.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "AHK_BASE_PATH=$($baseFile.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Compile Script
        shell: powershell
        run: |
          Write-Host "Compiling AutoReSizer.ahk..."
          Write-Host "Source file exists: $(Test-Path 'AutoReSizer.ahk')"
          
          if (!(Test-Path 'AutoReSizer.ahk')) {
            Write-Host "Current directory:"
            Get-Location
            Write-Host "Files in directory:"
            Get-ChildItem
            exit 1
          }
          
          # Kompilieren
          & "$env:AHK2EXE_PATH" /in "AutoReSizer.ahk" /out "AutoReSizer.exe" /bin "$env:AHK_BASE_PATH"
          
          # Prüfen
          if (Test-Path "AutoReSizer.exe") {
            Write-Host "✅ Success! Compiled file size: $((Get-Item 'AutoReSizer.exe').Length) bytes"
          } else {
            Write-Host "❌ Compilation failed"
            Write-Host "Trying alternative method..."
            
            # Alternative: Versuche direkt mit AutoHotkey zu kompilieren
            $ahkExe = Get-ChildItem -Path "C:\ahk_temp\ahk" -Recurse -Filter "AutoHotkey64.exe" | Select-Object -First 1
            Start-Process -Wait -FilePath $ahkExe.FullName -ArgumentList "`"$env:AHK2EXE_PATH`" /in `"AutoReSizer.ahk`" /out `"AutoReSizer.exe`" /bin `"$ahkExe.FullName`""
          }

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: AutoReSizer
          path: AutoReSizer.exe
          retention-days: 7
