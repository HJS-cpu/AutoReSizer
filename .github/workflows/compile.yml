name: Compile AHK v2

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Erlaubt manuelles Ausl√∂sen

jobs:
  compile:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Compile AHK v2 Script
      shell: powershell
      run: |
        # Debug: Zeige Verzeichnisinhalt
        Write-Host "=== DEBUG: Repository Inhalt ==="
        Get-ChildItem -Recurse | Select-Object Name, FullName | Format-Table -AutoSize
        Write-Host "==============================="
        
        # Quellscript pr√ºfen
        $sourceFile = "AutoReSizer.ahk"
        if (-not (Test-Path $sourceFile)) {
            Write-Host "‚ùå ERROR: $sourceFile nicht gefunden!" -ForegroundColor Red
            Write-Host "Suche nach AHK Dateien..." -ForegroundColor Yellow
            Get-ChildItem -Recurse -Filter *.ahk | Select-Object FullName
            exit 1
        }
        
        Write-Host "‚úÖ $sourceFile gefunden" -ForegroundColor Green
        
        # 1. AutoHotkey v2 portable Version herunterladen
        Write-Host "`nüì• Lade AutoHotkey v2 herunter..." -ForegroundColor Cyan
        $ahkUrl = "https://github.com/AutoHotkey/AutoHotkey/releases/download/v2.0.11/AutoHotkey_2.0.11.zip"
        $downloadPath = "$env:TEMP\ahk2.zip"
        $extractPath = "$env:TEMP\ahk2"
        
        # Herunterladen
        Invoke-WebRequest -Uri $ahkUrl -OutFile $downloadPath -UseBasicParsing
        
        # Entpacken
        if (Test-Path $extractPath) { Remove-Item $extractPath -Recurse -Force }
        Expand-Archive -Path $downloadPath -DestinationPath $extractPath -Force
        
        # 2. Ahk2Exe und AutoHotkey64.exe finden
        Write-Host "`nüîç Suche Compiler..." -ForegroundColor Cyan
        $ahk2exe = Get-ChildItem -Path $extractPath -Recurse -Filter "Ahk2Exe.exe" | Select-Object -First 1 -ExpandProperty FullName
        $ahk64exe = Get-ChildItem -Path $extractPath -Recurse -Filter "AutoHotkey64.exe" | Select-Object -First 1 -ExpandProperty FullName
        
        if (-not $ahk2exe -or -not $ahk64exe) {
            Write-Host "‚ùå Compiler oder Base-File nicht gefunden!" -ForegroundColor Red
            Write-Host "Inhalt von $extractPath :"
            Get-ChildItem -Path $extractPath -Recurse | Select-Object Name, FullName | Format-Table -AutoSize
            exit 1
        }
        
        Write-Host "‚úÖ Ahk2Exe gefunden: $ahk2exe" -ForegroundColor Green
        Write-Host "‚úÖ AutoHotkey64.exe gefunden: $ahk64exe" -ForegroundColor Green
        
        # 3. Kompilierung durchf√ºhren
        Write-Host "`nüî® Kompiliere $sourceFile ..." -ForegroundColor Cyan
        $outputFile = "AutoReSizer.exe"
        
        # Kommando ausf√ºhren
        $compileCommand = "`"$ahk2exe`" /in `"$(Get-Item $sourceFile).FullName`" /out `"$outputFile`" /bin `"$ahk64exe`""
        Write-Host "Ausf√ºhre: $compileCommand"
        
        # Kompilieren
        $process = Start-Process -FilePath $ahk2exe -ArgumentList "/in `"$(Get-Item $sourceFile).FullName`" /out `"$outputFile`" /bin `"$ahk64exe`"" -Wait -NoNewWindow -PassThru
        
        if ($process.ExitCode -ne 0) {
            Write-Host "‚ö†Ô∏è Kompilierung gab Exit-Code $($process.ExitCode) zur√ºck" -ForegroundColor Yellow
        }
        
        # 4. Ergebnis pr√ºfen
        Write-Host "`nüìä Pr√ºfe Ergebnis..." -ForegroundColor Cyan
        if (Test-Path $outputFile) {
            $fileSize = (Get-Item $outputFile).Length
            $fileInfo = Get-Item $outputFile
            Write-Host "‚úÖ SUCCESS: $outputFile erstellt!" -ForegroundColor Green
            Write-Host "   Gr√∂√üe: $fileSize Bytes" -ForegroundColor White
            Write-Host "   Pfad: $($fileInfo.FullName)" -ForegroundColor White
            Write-Host "   Erstellt: $($fileInfo.CreationTime)" -ForegroundColor White
        } else {
            Write-Host "‚ùå FEHLER: $outputFile wurde nicht erstellt!" -ForegroundColor Red
            
            # Alternativen versuchen
            Write-Host "`nüîÑ Versuche alternative Methode..." -ForegroundColor Yellow
            
            # Methode 2: Direkt mit PowerShell
            $sourceContent = Get-Content $sourceFile -Raw
            if ($sourceContent -match "^#Requires AutoHotkey v2") {
                Write-Host "Script ist AHK v2" -ForegroundColor Green
            }
            
            # Methode 3: Manuelle Kompilierung simulieren
            Write-Host "Kopiere AutoHotkey64.exe als Fallback..."
            Copy-Item $ahk64exe -Destination "AutoReSizer.exe" -Force
            
            if (Test-Path "AutoReSizer.exe") {
                Write-Host "‚ö†Ô∏è Fallback-EXE erstellt (nicht kompiliert)" -ForegroundColor Yellow
            } else {
                exit 1
            }
        }

    - name: Upload executable
      uses: actions/upload-artifact@v4
      with:
        name: AutoReSizer-Executable
        path: AutoReSizer.exe
        retention-days: 7
        
    - name: Create Release (optional)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: AutoReSizer.exe
        generate_release_notes: true
