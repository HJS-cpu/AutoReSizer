name: Build AutoReSizer EXE and ZIP

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download AutoHotkey v1 (Compiler) + AutoHotkey v2 (Base)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          New-Item -ItemType Directory -Force -Path "$env:RUNNER_TEMP\ahk1" | Out-Null
          New-Item -ItemType Directory -Force -Path "$env:RUNNER_TEMP\ahk2" | Out-Null

          Invoke-WebRequest `
            -Uri "https://github.com/AutoHotkey/AutoHotkey/releases/download/v1.1.37.02/AutoHotkey_1.1.37.02.zip" `
            -OutFile "$env:RUNNER_TEMP\ahk1.zip"
          Expand-Archive -Path "$env:RUNNER_TEMP\ahk1.zip" -DestinationPath "$env:RUNNER_TEMP\ahk1" -Force

          Invoke-WebRequest `
            -Uri "https://github.com/AutoHotkey/AutoHotkey/releases/download/v2.0.11/AutoHotkey_2.0.11.zip" `
            -OutFile "$env:RUNNER_TEMP\ahk2.zip"
          Expand-Archive -Path "$env:RUNNER_TEMP\ahk2.zip" -DestinationPath "$env:RUNNER_TEMP\ahk2" -Force

      - name: Compile AutoHotkey v2 script to EXE (with icon)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $ws = $env:GITHUB_WORKSPACE
          Set-Location $ws

          if (-not (Test-Path "$ws\AutoReSizer.ahk")) { throw "Missing AutoReSizer.ahk in repository root." }
          if (-not (Test-Path "$ws\Icons\icon.ico")) { throw "Missing icon file: Icons/icon.ico" }

          $Ahk2Exe = Get-ChildItem "$env:RUNNER_TEMP\ahk1" -Recurse -Filter "Ahk2Exe.exe" |
                     Select-Object -First 1 -ExpandProperty FullName
          if (-not $Ahk2Exe) { throw "Ahk2Exe.exe not found in extracted AHK v1 package." }

          $BaseBin = Get-ChildItem "$env:RUNNER_TEMP\ahk2" -Recurse -Filter "AutoHotkey64.exe" |
                     Select-Object -First 1 -ExpandProperty FullName
          if (-not $BaseBin) { throw "AutoHotkey64.exe not found in extracted AHK v2 package." }

          $inScript = "$ws\AutoReSizer.ahk"
          $outExe   = "$ws\AutoReSizer.exe"
          $iconFile = "$ws\Icons\icon.ico"

          Write-Host "Compiler: $Ahk2Exe"
          Write-Host "Base:     $BaseBin"
          Write-Host "In:       $inScript"
          Write-Host "Out:      $outExe"
          Write-Host "Icon:     $iconFile"

          & $Ahk2Exe /in $inScript /out $outExe /icon $iconFile /bin $BaseBin

          if (-not (Test-Path $outExe)) {
            Write-Host "Workspace contents (for debugging):"
            Get-ChildItem -Path $ws -Force | Select-Object FullName
            throw "Compile failed: expected output not found at $outExe"
          }

      - name: Create ZIP package
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $ws = $env:GITHUB_WORKSPACE
          Set-Location $ws

          $files = @(
            "AutoReSizer.exe",
            "Deutsch.lng",
            "English.lng",
            "license.txt",
            "readme.txt"
          )

          foreach ($f in $files) {
            if (-not (Test-Path "$ws\$f")) { throw "Missing file for ZIP: $f" }
          }

          $zip = "$ws\AutoReSizer.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }

          Compress-Archive -Path $files -DestinationPath $zip -Force

          if (-not (Test-Path $zip)) { throw "ZIP creation failed: AutoReSizer.zip not created." }

      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: AutoReSizer
          path: AutoReSizer.zip
          if-no-files-found: error
